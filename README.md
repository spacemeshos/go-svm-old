# go-svm

Go bindings for [SVM](https://github.com/spacemeshos/svm)

## High-level API

**This documentation is still WIP - the final API is not finalized yet.**

For now, the documentation will only contain pseudo-code level API.

Each binary (over-the-wire) transaction will always have two parts:

- `Envelope` - A Transaction **agnostic** content.
- `Message` - A Transaction **specific** content.

Each `Message` will be accompanied by the `Envelope` to form together a complete binary Transaction.

In addition to the explicit data sent over-the-wire, there will be implicit fields inferred from it.
One such example, is the `Transaction Id`. For the context of this document, we won't regard these implied fields as part of the Transaction.

Adding to a binary Transaction, there is the `Execution Context` (or alternatively the `Transaction Context` or simply `Context`).
The `Context` structure will contain additional data (alongside the `Transaction`) to be used by SVM when executing a Transaction.
It will contain data relevant to the currently executing context within the Node (i.e `go-spacemesh`) and properties implied from the `Transaction` itself
(such as the `Transaction Id`).

## Envelope

- `version` - For versioning (to ease introducing new changes in the future).
- `type` - The Transaction type (`Deploy / Spawn / Call`)
- `principal` - The `Address` of the `Account` paying for the Gas.
- `amount` - For funding the `target` account (relevant only for `Spawn/Call` transactions).
- `nonce` - The transaction's `nonce`.
- `gas_limit` - Maximum units of Gas to be paid.
- `gas_fee` - Fee per Unit of Gas.

### Messages

There are in total 3 types of Transactions under SVM - each with its own corresponding `Message`:

- `Deploy Message` - For deploying Templates.
- `Spawn Message` - For Spawning new accounts out of existing Templates.
- `Call Message` - For calling an existing accounts.

### Deploy Message

The `Deploy Message` will be generated by the `Template compiler`.
Right now it'll be using the `SVM SDK`, but in the future there might be more ways to achieve that.

**Important**: There are no assumptions regarding the order of the Sections.

```text
+----------------+
|                |
| Code Section   |
|                |
+----------------+
|                |
| Data Section   |
|                |
+----------------+
|                |
| Ctors Section  |
|                |
+----------------+
|                |
| Header Section | (Optional)
|                |
+----------------+
|                |
| Schema Section | (Optional)
|                |
+----------------+
|                |
| API Section    | (Optional)
|                |
+----------------+
```

After a successful deploy of a `Template` an additional Section called `Deploy Section` will be appended to the input `Deploy Message`.
Then, the whole `Template` will be stored inside the `Global State` managed by `SVM` as well.

### Spawn Message

Each `Spawn Message` contain the following fields:

- `template` (Template Address) - The `Template` we'll spawn an Account from.
- `name` (String) - The name of the `Account` (optional).
- `ctor` (String) - The constructor identifier to execute.
- `calldata` (Blob) - The input for the constructor to run.

### Call Message

Each `Call Message` contain the following fields:

- `target` (Account Address) - The `Address` of the `Account` which we're calling.
- `function` (String) - The function`s name to execute.
- `verifydata` (Blob) - The input for the `svm_verify` function.
- `calldata` (Blob) - The input for the the function to run.

### Deploying a Template

Deploying a Template exposes two dedicated APIs: `ValidateDeploy` and `Deploy`.

#### Validate Deploy

Syntactically validates the `Deploy Message` given in a binary form and returns whether it's valid or not.
If it's not valid, a `ValidateError` will be returned as well.

```go
func ValidateDeploy(rt Runtime, msg []byte) (bool, ValidateError)
```

### Deploy

Performs the actual deployment of a Template. Returns a `DeployReceipt` in return.

```go
func Deploy(rt Runtime, env Envelope, msg []byte, ctx Context) DeployReceipt
```

A `DeployReceipt` will consist of:

- `success` - Whether the transaction succeeded or not.
- `error` - Will return `SvmError` (see later for more details) in case the transaction has failed.
- `addr` - The generated `Template Address` for the deployed `Template` (when deployment succeeded).
- `gas_used` - The amount of `Gas` units used for executing the transaction.
- `logs` - Collected logs during execution.

**TODO** - We might end up avoiding the `logs` field for the `Deploy` transaction.

### Spawn

Performs the spawning of a new `Account` out of existing `Template`.
Similarly to `Deploy` - spawning a new `Account` exposes two dedicated APIs: `ValidateSpawn` and `Spawn`.

#### Validate Spawn

Syntactically validates the `Spawn Message` given in a binary form and returns whether it's valid or not.
If it's not valid, a `ValidateError` will be returned as well.

```go
func ValidateSpawn(rt Runtime, msg []byte) (bool, ValidateError)
```

#### Spawn

Performs the actual spawning of an `Account`. Returns a `SpawnReceipt` in return.

A `SpawnReceipt` will consist of:

- `success` - Whether the transaction has succeeded or not.
- `error` - Will return `SvmError` (see later for more details) in case the transaction has failed.
- `addr` - The generated `Account Address` for the newly spawned `Account` (when spawning succeeded).
- `init_state` - The `Global State` updated `Root Hash` after the transaction has finished (when spawning succeeded).
- `returndata` - The encoded Blob of returned data by the constructor running as part of the transaction.
- `gas_used` - The amount of `Gas` units used for executing the transaction.
- `logs` - Collected logs during execution of the constructor function.

**TODO** - We might end up enforcing the constructor returning nothing (i.e `nil`) - in such a case we could manage without the `returndata` field!

### Call

Performs calling an existing `Account`.
Similarly to `Deploy` and `Spawn` - calling an `Account` exposes two dedicated APIs: `ValidateCall` and `Call`:

#### Validate Call

Syntactically validates the `Call Message` given in a binary form and returns whether it's valid or not.
If it's not valid, a `ValidateError` will be returned as well.

```go
func ValidateCall(rt Runtime, msg []byte) (bool, ValidateError)
```

#### Call

Performs the actual calling an `Account`. Returns a `CallReceipt` in return.

A `CallReceipt` will consist of:

- `success` - Whether the transaction has succeeded or not.
- `error` - Will return `SvmError` (see later for more details) in case the transaction has failed.
- `new_state` - The `Global State` updated `Root Hash` after the transaction has finished (when call succeeded).
- `returndata` - The encoded Blob of returned data by the called function.
- `gas_used` - The amount of `Gas` units used for executing the transaction.
- `logs` - Collected logs during execution of the constructor function.

### Verify

Performs the `verify` stage as dictated by the [Account Unification](https://github.com/spacemeshos/SMIPS/issues/49) design.
Since the `verify` flow involves the running Wasm function as done when running a `Call` transaction, the output will be of type `CallReceipt` as well.

```go
func Verify(rt Runtime, env Envelope, msg []byte, ctx Context) CallReceipt
```

### Get Account

Retrieving the most basic information of an `Account`

The fields returned:

- `balance` - The balance of the `Account`
- `counter` - The counter of the `Account` (used for implementing the `Nonce Scheme`).
- `template_addr` - The `Template Address` associated with the `Account`.

```go
func GetAccount(rt Runtime, addr Address) Account
```

Returns `nil` if no such `Account` exist.

### Increase An Account's Balance

Increases the balance of an `Account` (i.e printing coins)

```go
func IncreaseAccount(rt Runtime, addr Address, amount Amount)
```

**TODO** - determine what to do in case there is no `Account` associated with the given `Address`.

### Rewind

Rewinds the `Global State` to an historical layer.

```go
func Rewind(rt Runtime, layer Layer)
```

If the given `layer` is in the future - then it's an undefined behavior.

### Commit

Commits the currently dirty-changes into the `Global State` and returns its new computed `Root State Hash`.

```go
func Commit(rt Runtime) State
```

If the persistence operation failed - then it's an undefined behavior.

### SvmError

```go
struct SvmError {
    Parse ParseError
    Program ProgramError,
    FixedGas FixedGasError,
}

// TBD
struct ParseError { }

// TBD
struct ProgramError { }

```

### Nonces Schemes API

TBD. The changes required by the [Nonces Schemes SMIP](https://github.com/spacemeshos/SMIPS/issues/59) have not been finalized yet.
